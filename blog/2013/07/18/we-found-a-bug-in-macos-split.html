<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

<head>
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 
   <title>We found a bug in the split command of Mac OS</title>
 
 <meta name="author" content="Alexandre Rademaker" />
 <link href="http://feeds.feedburner.com/arademaker" rel="alternate"
       title="Alexandre Rademaker" type="application/atom+xml" />
 
 <!-- syntax highlighting CSS -->
 <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
 <link rel="stylesheet" href="/css/table.css" type="text/css" />

 <!-- <link href="/css/highlight.css" rel="stylesheet" type="text/css"> -->
 <link href="/css/gists.css" rel="stylesheet" type="text/css"/>

 <!-- CSS -->
 <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />

 <!-- Typekit 
 <script type="text/javascript" src="http://use.typekit.com/jpd0pfm.js"></script>
 <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
 -->

 <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>



<!-- Google Analytics -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-97240-6']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>

<body>
  <div id="outer">
    <div id="top"></div>

    <div id="left">
      <img src="/images/eu-sf.jpg"/>
    </div>  

    <div class="site">
      <div class="title">
	<a href="/">Alexandre Rademaker</a>
	<a class="extra" href="/about.html">about me</a>
	<a class="extra" href="/publications.html">publications</a>
	<a class="extra" href="/advising.html">advising</a>
        <a class="extra" href="/research.html">research</a>
	<a class="extra" href="/teaching.html">teaching</a>
      </div>
      
      <div id="post">
  <h1> We found a bug in the split command of Mac OS </h1>

  <p>Yesterday my friend
<a href="http://researcher.ibm.com/researcher/view.php?person=br-mnerys">Marcelo Nery</a>
and I found a bug in the <code class="highlighter-rouge">split</code> command of Mac OS. At first, I was
surprised (we don’t expect to find bugs in core tools like grep, ls,
split, wc…, right?) and almost expected to find the same bug in the
Linux version of split. At least in the split of Ubuntu distribution,
that was not the case. The bug is presented only in the Mac OS
version.</p>

<h2 id="the-bug">The bug</h2>

<p>Consider the file <code class="highlighter-rouge">zero.log</code> created with the following Common Lisp code
(actually for the rest of the post you don’t need to understand the
code):</p>

<figure class="highlight"><pre><code class="language-common-lisp" data-lang="common-lisp"><span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">out</span> <span class="s">"zero.log"</span> <span class="ss">:element-type</span> <span class="o">'</span><span class="p">(</span><span class="kt">unsigned-byte</span> <span class="mi">8</span><span class="p">)</span>
			      <span class="ss">:direction</span> <span class="ss">:output</span>
			      <span class="ss">:if-exists</span> <span class="ss">:supersede</span>
			      <span class="ss">:external-format</span> <span class="ss">:utf-8</span><span class="p">)</span>
	   <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nb">char</span> <span class="nv">across</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">"AB_CDE~%F~%G~%"</span><span class="p">)</span>
		     <span class="nb">do</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">equal</span> <span class="nb">char</span> <span class="sc">#\_</span><span class="p">)</span>
			      <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">1</span> <span class="nv">to</span> <span class="mi">3</span> <span class="nb">do</span>
                     <span class="p">(</span><span class="nb">write-byte</span> <span class="mi">0</span> <span class="nv">out</span><span class="p">))</span>
			      <span class="p">(</span><span class="nb">write-byte</span> <span class="p">(</span><span class="nb">char-code</span> <span class="nb">char</span><span class="p">)</span> <span class="nv">out</span><span class="p">))))</span></code></pre></figure>

<p>This file content could be inspected with hexdump command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>hexdump <span class="nt">-C</span> zero.log
00000000  41 42 00 00 00 43 44 45  0a 46 0a 47 0a     |AB...CDE.F.G.|
0000000d</code></pre></figure>

<p>That is, the file has three 0 bytes in the first line right after the
<code class="highlighter-rouge">B</code> letter and before the <code class="highlighter-rouge">C</code> letter. Now we want to split this file
one line per file.</p>

<p>The Linux version of split works as expected, it splits the file
keeping the zero bytes unchanged.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">split</span> <span class="nt">-1</span> zero.log
<span class="nv">$ </span><span class="k">for </span>f <span class="k">in </span>x??<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"---Begin: </span><span class="nv">$f</span><span class="s2">"</span><span class="p">;</span> <span class="nb">cat</span> <span class="nv">$f</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"---End: </span><span class="nv">$f</span><span class="s2">"</span><span class="p">;</span> <span class="k">done</span>
<span class="nt">---Begin</span>: xaa
ABCDE
<span class="nt">---End</span>: xaa
<span class="nt">---Begin</span>: xab
F
<span class="nt">---End</span>: xab
<span class="nt">---Begin</span>: xac
G
<span class="nt">---End</span>: xac</code></pre></figure>

<p>Moreover, the sum of bytes of the <code class="highlighter-rouge">x??</code> files is equal the number of
bytes in the <code class="highlighter-rouge">zero.log</code> file, 13 bytes.</p>

<p>Nevertheless, the Mac OS version of split produces an unexpected
output. The letter <code class="highlighter-rouge">F</code> is merged with the begining of the first line
althouth it is in the second line of the <code class="highlighter-rouge">zero.log</code> file. Besides
that, the zero bytes causes the Mac OS split to ignore the rest of the
first line of <code class="highlighter-rouge">zero.log</code> causing a lost of data. The sum of the bytes
of the <code class="highlighter-rouge">x??</code> files in Mac OS is only 6 bytes.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">split</span> <span class="nt">-1</span> zero.log
<span class="nv">$ </span><span class="k">for </span>f <span class="k">in </span>x??<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"---Begin: </span><span class="nv">$f</span><span class="s2">"</span><span class="p">;</span> <span class="nb">cat</span> <span class="nv">$f</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"---End: </span><span class="nv">$f</span><span class="s2">"</span><span class="p">;</span> <span class="k">done</span>
<span class="nt">---Begin</span>: xaa
ABF
<span class="nt">---End</span>: xaa
<span class="nt">---Begin</span>: xab
G
<span class="nt">---End</span>: xab</code></pre></figure>

<h2 id="reporting-the-bug">Reporting the bug</h2>

<p>I reported the bug to Apple using the
<a href="http://www.apple.com/feedback/macosx.html">Mac OS Feedback form</a>.</p>



 <hr/>

 <div id="disqus_thread"></div>
 <script type="text/javascript">
   var disqus_shortname = 'arademaker'; 
   (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
 </script>
 <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




      <div class="footer">
	<div class="contact">
	  <p>
            Professor at <a href="http://emap.fgv.br/">EMAp/FGV</a>, Researcher at <a href="http://research.ibm.com">IBM</a><br/>
            arademaker AT gmail DOT com
	  </p>
	  
	  <p><a id="academia-button" href="https://ibm.academia.edu/AlexandreRademaker">Follow me on Academia.edu</a><script src="//a.academia-assets.com/javascripts/social.js"></script></p>

	  <p>
	    <a href="http://github.com/arademaker/">github.com/arademaker</a> - 
            <a href="http://twitter.com/arademaker/">twitter.com/arademaker</a> - 
            <a href="http://facebook.com/alexandre.rademaker">Facebook</a> -
	    <a href="https://scholar.google.com.br/citations?user=SWz6BjIAAAAJ&hl=en">Google Scholar</a>
	  </p>
	  <p>The postings and pages on this site are my own and don't
	    necessarily represent IBM's or FGV's positions, strategies
	    or opinions.</p>
	</div>	
	<div class="rss">
	  <p><a href="http://feeds.feedburner.com/arademaker"><img src="/images/rss.png" alt="Subscribe to RSS Feed" /></a></p>
	</div>
      </div>
    </div>

    <div id="right">
    </div>
  </div>
</body>
</html>
